# Изменения: Система логирования вопросов и ответов

## Добавленные файлы

### 1. `app/logger.py`
- Класс `QALogger` для логирования вопросов и ответов
- Поддержка обычных и потоковых запросов
- Логирование в JSONL формате
- Методы для чтения и очистки логов

### 2. `scripts/view_logs.py`
- Скрипт для удобного просмотра логов
- Поддержка фильтрации по ошибкам
- Ограничение количества записей
- Форматированный вывод

### 3. `LOGGING.md`
- Полная документация по системе логирования
- Примеры использования
- Рекомендации по безопасности

### 4. `CHANGELOG_LOGGING.md`
- Этот файл с описанием изменений

## Измененные файлы

### 1. `app/schemas.py`
- Добавлены схемы `LogEntry` и `LogsResponse` для API

### 2. `app/config.py`
- Добавлена настройка `logs_path` для пути к файлу логов

### 3. `app/api/chat.py`
- Добавлено логирование в функции `query()` и `query_stream()`
- Добавлены API эндпоинты `/api/logs` и `DELETE /api/logs`
- Измерение времени обработки запросов
- Сбор полных ответов для потоковых запросов

## Новые API эндпоинты

### GET /api/logs
Получение логов вопросов и ответов
- Параметр `limit` - максимальное количество записей (по умолчанию 100)
- Возвращает список логов в формате JSON

### DELETE /api/logs
Очистка всех логов
- Удаляет файл с логами

## Формат логов

Логи сохраняются в JSONL формате в файл `./data/logs/qa_logs.jsonl`:

```json
{
  "timestamp": "2024-01-15T10:30:45.123456",
  "type": "regular|stream",
  "request": {
    "question": "Вопрос пользователя",
    "return_sources": true
  },
  "response": {
    "answer": "Ответ системы",
    "sources_count": 3
  },
  "processing_time_seconds": 2.45,
  "error": null,
  "status": "success|error"
}
```

## Автоматическое логирование

Система автоматически логирует:
1. Все запросы к `/api/query` (обычные)
2. Все запросы к `/api/query/stream` (потоковые)
3. Ошибки с описанием проблемы
4. Время обработки каждого запроса

## Использование

### Просмотр логов через скрипт:
```bash
# Последние 50 записей
python3 scripts/view_logs.py

# Только ошибки
python3 scripts/view_logs.py --errors-only

# Последние 100 записей
python3 scripts/view_logs.py --limit 100
```

### Просмотр логов через API:
```bash
# Получить последние 50 логов
curl http://localhost:8000/api/logs?limit=50

# Очистить все логи
curl -X DELETE http://localhost:8000/api/logs
```

## Настройка

Путь к файлу логов можно изменить через переменную окружения:
```env
LOGS_PATH=./data/logs/qa_logs.jsonl
```

## Безопасность

⚠️ **Важно**: Логи содержат пользовательские данные. Рекомендуется:
- Ограничить доступ к файлам логов
- Настроить ротацию логов
- Регулярно очищать старые логи
- Соблюдать требования GDPR
