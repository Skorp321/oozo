# Исправление проблемы дублирующихся чанков

## Проблема
При запросе "какой предмет договора?" система находила 5 одинаковых фрагментов "Предмет договора" вместо 5 разных чанков с информацией.

## Причина
Система использовала `RecursiveCharacterTextSplitter`, который просто разбивает текст по символам, не учитывая семантическую структуру документа. Это приводило к созданию одинаковых чанков.

## Решение

### 1. Интеграция семантического разделения
- Добавлен импорт `DocumentChunker` в `main.py`
- Обновлен метод `split_documents()` для использования семантического анализа
- Система теперь автоматически определяет структуру документа и создает чанки по разделам

### 2. Дедупликация результатов поиска
- Создан кастомный ретривер `DeduplicationRetriever` с логикой дедупликации
- Обновлен метод `similarity_search()` для фильтрации дублирующихся результатов
- Система проверяет уникальность по содержимому и метаданным раздела

### 3. Улучшенные настройки
- Уменьшен размер чанка с 1000 до 500 символов
- Уменьшено перекрытие с 100 до 50 символов
- Увеличено количество результатов поиска с 4 до 5

### 4. Новые API endpoints
- Добавлен endpoint `/api/reindex` для полной переиндексации
- Обновлен endpoint `/api/ingest` с информацией о типах чанков

## Как применить исправления

### Вариант 1: Через API (рекомендуется)
```bash
# Переиндексация через API
curl -X POST http://localhost:8000/api/reindex
```

### Вариант 2: Через скрипт
```bash
# Запуск скрипта переиндексации
cd rad_project
python reindex_documents.py
```

### Вариант 3: Перезапуск контейнеров
```bash
# Перезапуск с новыми настройками
docker-compose down
docker-compose up --build
```

## Проверка исправления

После переиндексации запрос "какой предмет договора?" должен возвращать:
- 5 разных чанков с уникальным содержимым
- Каждый чанк должен содержать информацию о предмете договора
- В логах должно быть указано количество семантических чанков

## Логи для мониторинга

Система теперь выводит подробные логи:
- Количество созданных чанков (семантических и fallback)
- Количество уникальных документов из кандидатов
- Информация о заголовках и разделах чанков

## Структура метаданных чанков

Новые чанки содержат расширенные метаданные:
- `chunk_type`: 'semantic' или 'fallback'
- `chunk_title`: заголовок раздела
- `section_number`: номер раздела
- `hierarchy_path`: путь в иерархии документа 